<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>420 Clock</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="site.webmanifest">
    <link rel="icon" type="image/png" sizes="192x192" href="img/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="img/android-chrome-512x512.png">

</head>
<body class="body_clock">
    <div id="debug-container" style="display:block; color:white; background-color:darkgreen">
        <p>//DEBUG CONTROLS//</p>
        <label><input type="checkbox" id="debug420"> //Force 4:20 Mode</label><br />
        <label><input type="checkbox" id="debug422"> //Force 4:22 Flag</label><br />
        <label><input type="checkbox" id="debugFriday"> //Is it Friday?</label><br />
    </div>

    <div id="audio-container">
        <audio id="audio420" src="snd/smokeweedeveryday_og.mp3" preload="auto"></audio>
        <audio id="audio420friday" src="snd/smokeweedeveryday_remix.mp3" preload="auto"></audio>
        <audio id="silentButDeadly" src="snd/silence.mp3" preload="auto"></audio>
    </div>

    <div id="clock">
        Loading...
    </div>

    <div id="audioPrompt">
        <h6>ðŸ”Š Click anywhere to enable sound! ðŸ”Š</h6>
    </div>

    <script id="420clockScript">
        // UI elements
        const clock = document.getElementById('clock');
        const audioPrompt = document.getElementById('audioPrompt');
        const debugCheckbox = document.getElementById('debug420');           // Force 420 mode
        const debugFridayCheckbox = document.getElementById('debugFriday');  // Force Friday
        const debug422Checkbox = document.getElementById('debug422');

        // Audio elements
        // Silent audio added to fix bug where UnlockAudioOnce() stops the music if 420 mode is already active.
        const silentAudio = document.getElementById('silentButDeadly');
        const audio420 = document.getElementById('audio420');
        const audio420friday = document.getElementById('audio420friday');

        // 420 mode variables
        let flashing = false;
        let flashInterval = null;
        let leafInterval = null;
        const leafImage = 'img/weedleaf.png';

        // Debug variables
        let debugForce420Mode = false;
        let debugForceTodayToBeFriday = false;
        let debugForce422FlagTrue = false;
        // Add event listeners to unlock audio on user interaction
        document.addEventListener("mouseenter", unlockAudioOnce, { once: true });
        document.addEventListener("click", unlockAudioOnce, { once: true });

        // Initialize time variables
        let now;
        let hours;
        let minutes;
        let seconds;
        let isFriday;
        let is422;
        let isPM;
        let in420Window;

        // Clock display variables
        let displayHours;
        let timeStr;

        function unlockAudioOnce() {
            silentAudio.play().then(() => {
                silentAudio.pause();
                silentAudio.currentTime = 0;
                console.log("Attempting to unlock audio silently.");
                audioPrompt.style.display = 'none';
            }).catch((err) => {
                console.warn("Audio Still Blocked:", err);
            });
        }

        function spawnLeaf() {
            const leaf = document.createElement('img');
            leaf.src = leafImage;
            leaf.className = 'leaf';
            leaf.style.left = Math.random() * 100 + 'vw';
            leaf.style.animationDuration = (Math.random() * 3 + 3) + 's';
            leaf.style.transform = `rotate(${Math.random() * 360}deg)`;
            document.body.appendChild(leaf);
            setTimeout(() => leaf.remove(), 10000);
        }

        function enter420Mode(isFriday) {
            if (!flashing) {
                flashing = true;
                if (isFriday) {
                    audio420friday.play().catch(() => { });
                } else {
                    audio420.play().catch(() => { });
                }
                flashInterval = setInterval(() => {
                    document.body.style.backgroundColor =
                        document.body.style.backgroundColor === 'black' ? '#00ff00' : 'black';
                    clock.style.color = document.body.style.backgroundColor === 'black' ? 'white' : 'black';
                }, 500);
                leafInterval = setInterval(spawnLeaf, 300);
            }
            const is422 = ((hours === 4 && minutes === 22) || (debugForce422FlagTrue));
            if (!is422)
            {
                clock.textContent = 'HAPPY 4:20!!!';
            }
            else if (is422)
            {
                clock.textContent = 'HAPPY 4:22!!!';
            }
        }

        function exit420Mode(isFriday) {
            if (flashing) {
                flashing = false;
                if (isFriday) {
                    audio420friday.pause();
                    audio420friday.currentTime = 0;
                } else {
                    audio420.pause();
                    audio420.currentTime = 0;
                }
                clearInterval(flashInterval);
                clearInterval(leafInterval);
                document.body.style.backgroundColor = 'black';
                clock.style.color = 'white';
            }
        }

        function updateClock() {
            now = new Date();
            debugForceTodayToBeFriday = debugFridayCheckbox?.checked || false;
            debugForce422FlagTrue = debug422Checkbox?.checked || false;

            isFriday = (now.getDay() === 5) || debugForceTodayToBeFriday;

            hours = now.getHours();
            minutes = now.getMinutes();
            seconds = now.getSeconds();

            is422 = (minutes === 22) || debugForce422FlagTrue;
            isPM = hours >= 12;
            in420Window =
                ((hours === 4 || hours === 16) &&
                    ((minutes === 20 && seconds < 60) ||
                        (minutes === 22 && seconds < 60)));

            debugForce420Mode = debugCheckbox?.checked || false;

            if (debugForce420Mode || in420Window) {
                enter420Mode(isFriday);
            } else {
                exit420Mode(isFriday);
                displayHours = hours % 12 || 12;
                timeStr = `${displayHours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} ${isPM ? 'PM' : 'AM'}`;
                clock.textContent = timeStr;
            }
        }
        setInterval(updateClock, 1000);
        updateClock();
    </script>
</body>
</html>
